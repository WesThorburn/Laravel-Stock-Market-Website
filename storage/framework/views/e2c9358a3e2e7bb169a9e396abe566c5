<?php $__env->startSection('nav'); ?>
	<?php echo $__env->make('layouts.partials.nav-buttons', ['page' => 'dashboard'], array_except(get_defined_vars(), array('__data', '__path')))->render(); ?>
<?php $__env->stopSection(); ?>

<?php $__env->startSection('title'); ?>
	Dashboard
<?php $__env->stopSection(); ?>

<?php $__env->startSection('body'); ?>
	<div class="col-md-6 col-md-offset-3">
		<ul class="nav nav-tabs stocks-page-nav-tabs">
			<li role="presentation"><a href="/dashboard/discontinued">Discontinued Stocks</a></li>
			<li role="presentation" class="active"><a href="/dashboard/marketCapAdjustments">Market Cap Adjustments</a></li>
		</ul>
		<div class="panel panel-default single-pixel-top-margin">
			<div class="panel-heading"><b>All Stocks</b></div>
			<table class="table table-striped table-hover table-bordered table-condensed table-bordered-only-top-bottom no-margin-top" id="adjusted_stocks">
			    <thead>
			        <tr>
			            <th>Code</th>
			            <th>Name</th>  
			            <th>Yesterday's Mkt Cap (M)</th>          
			            <th>Current Mkt Cap (M)</th>
			            <th>Difference (M)</th>
			            <th>Day Change</th>
			            <th>Requires Adjustment</th>
			            <th></th>
			        </tr>
			    </thead>
			    <div class="panel-body">
			    	<tbody></tbody>
			    </div>
			</table>
		</div>
		<?php if($flaggedStocks->first()): ?>
			<div class="panel panel-default">
				<div class="panel-heading"><b>Flagged Stocks</b></div>
				<table class="table table-striped table-hover table-bordered table-condensed table-bordered-only-top-bottom no-margin-top" id="flagged_stocks">
				    <thead>
				        <tr>
				            <th>Code</th>
				            <th>Yesterday's Mkt Cap (M)</th>          
				            <th>Current Mkt Cap (M)</th>
				            <th>Difference (M)</th>
				            <th>Day Change</th>
				            <th>Requires Adjustment</th>
				        </tr>
				    </thead>
				    <tbody data-link="row" class="rowlink">
					    <?php foreach($flaggedStocks as $stock): ?>
							<tr>
								<td>
									<?php echo e($stock->stock_code); ?><a href="/stocks/<?php echo e($stock->stock_code); ?>"></a>
								</td>
								<td><?php echo e($stock->yesterdays_market_cap); ?></td>
								<td><?php echo e($stock->current_market_cap); ?></td>
								<td><?php echo e($stock->current_market_cap - $stock->yesterdays_market_cap); ?></td>
								<td><?php echo e($stock->percent_change); ?></td>
								<td>
									<?php if($stock->market_cap_requires_adjustment == 0): ?>
										No
									<?php elseif($stock->market_cap_requires_adjustment == 1): ?>
										Yes
									<?php endif; ?>
								</td>
							</tr>
						<?php endforeach; ?>
				    </tbody>
				</table>
			</div>
		<?php endif; ?>
	</div>

	<script>
		$(document).ready(function(){
			var stockTable = $('#adjusted_stocks').DataTable({
				processing: true,
				serverSide: true,
				ajax: '/dashboard/ajax/marketCapAdjustments',
				lengthMenu: [20,50,100],
				"order": [[ 4, "desc" ]],
				fnColumnCallback: function(nColumn){
					console.log(nColumn);
				},
				columns: [
					{data: 'stock_code', name: 'stocks.stock_code'},
					{data: 'company_name', name: 'company_name'},
					{data: 'yesterdays_market_cap', name: 'yesterdays_market_cap', searchable: false},
		            {data: 'current_market_cap', name: 'current_market_cap', searchable: false},
		            {data: 'difference', name: 'difference', searchable: false},
		            {data: 'percent_change', name: 'percent_change', searchable: false},
		            {data: 'market_cap_requires_adjustment', name: 'market_cap_requires_adjustment'},
		            {data: 'change_adjustment', name: 'change_adjustment'}
				]
			});		
			//Make table rows clickable
			$('#stock_table').delegate('tbody > tr', 'click', function(){
				var data = stockTable.row(this).data();
				window.location.assign('/stock/'+ data.stock_code)
			});

		});
	</script>
<?php $__env->stopSection(); ?>
<?php echo $__env->make('layouts.master', array_except(get_defined_vars(), array('__data', '__path')))->render(); ?>